<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIXA V21 FERRONI PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg: #f1f5f9; /* Màu nền xám nhẹ để làm nổi card trắng */
            --card: #ffffff; 
            --text: #1e293b; 
            --text-sub: #64748b; 
            --border: #e2e8f0;
            --primary: #84cc16; 
            --primary-grad: linear-gradient(135deg, #a3e635 0%, #65a30d 100%); /* 3D Gradient */
            --primary-light: #ecfccb;
            --primary-dark: #4d7c0f;
            --danger: #ef4444;
            
            /* SHADOW 3D & DEPTH */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            --chart-shopee: #ee4d2d; 
            --chart-tiktok: #000000; 
            --chart-lazada: #0f146d; 
            --chart-other: #84cc16;
            
            --header-h: 65px; 
            --footer-h: 75px;
            --radius: 16px;
        }

        [data-theme="dark"] {
            --bg: #0f172a; 
            --card: #1e293b; 
            --text: #f8fafc; 
            --text-sub: #94a3b8; 
            --border: #334155;
            --primary: #a3e635; 
            --primary-grad: linear-gradient(135deg, #bef264 0%, #65a30d 100%);
            --primary-light: rgba(163, 230, 53, 0.15);
            --primary-dark: #84cc16;
            --chart-tiktok: #ffffff;
            --chart-lazada: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Manrope', sans-serif; margin: 0; padding: 0; 
            width: 100%; height: 100%; overflow: hidden; user-select: none;
            transition: background 0.3s;
        }

        .hidden-inp { display: none !important; }

        /* HEADER */
        #fixed-header { 
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; 
            padding: 0 16px; z-index: 1000; transition: 0.3s; box-shadow: var(--shadow-sm);
        }
        [data-theme="dark"] #fixed-header { background: rgba(30, 41, 59, 0.9); }

        .brand-c { display: flex; align-items: center; gap: 10px; }
        .app-logo img { height: 40px; border-radius: 10px; box-shadow: var(--shadow); }
        .brand-name { font-weight: 800; font-size: 18px; color: var(--primary-dark); letter-spacing: -0.5px; }
        .brand-date { font-size: 11px; font-weight: 600; color: var(--text-sub); background: var(--border); padding: 2px 8px; border-radius: 6px; margin-top: 2px; }

        /* SCROLL & PAGE */
        #main-scroll { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            padding: calc(var(--header-h) + 16px) 16px calc(var(--footer-h) + 20px) 16px;
            overflow-y: auto; -webkit-overflow-scrolling: touch; z-index: 1; 
        }
        .page { display: none; opacity: 0; transform: translateY(10px); transition: 0.3s; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        /* TABS */
        .main-tabs { 
            display: flex; background: var(--card); border-radius: var(--radius); padding: 4px; margin-bottom: 20px; 
            box-shadow: var(--shadow-inner); border: 1px solid var(--border);
        }
        .tab-btn { flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 700; color: var(--text-sub); border-radius: 12px; transition: 0.2s; cursor: pointer; }
        .tab-btn.active { background: var(--bg); color: var(--primary-dark); box-shadow: var(--shadow-sm); }

        /* CHANNEL GRID - 3D Effect */
        .channel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .ch-box { 
            width: 100%; height: 50px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); 
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s;
            box-shadow: var(--shadow); /* Tạo độ nổi */
        }
        .ch-box:active { transform: translateY(2px); box-shadow: none; }
        .ch-box img { height: 24px; width: 24px; object-fit: contain; }
        .ch-box span { font-size: 13px; font-weight: 700; color: var(--text); }
        .ch-radio:checked + .ch-box { border-color: var(--primary); background: var(--primary-light); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .ch-radio:checked + .ch-box span { color: var(--primary-dark); }

        /* INPUT SCANNER */
        .inp-grp { position: relative; margin-bottom: 20px; }
        .inp-main { 
            width: 100%; background: var(--card); border: 1px solid var(--border); padding: 16px 55px 16px 16px; 
            border-radius: var(--radius); color: var(--text); font-size: 15px; font-weight: 600; box-shadow: var(--shadow);
        }
        .btn-scan { 
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
            width: 40px; height: 40px; background: var(--primary-grad); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            box-shadow: 0 4px 10px var(--primary-light); transition: 0.2s;
        }
        .btn-scan:active { transform: translateY(-50%) scale(0.95); }

        /* MEDIA BOX */
        .media-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .media-c { 
            aspect-ratio: 1; background: var(--card); border: 2px dashed var(--border); border-radius: var(--radius); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;
            box-shadow: var(--shadow-sm); transition: 0.2s;
        }
        .media-c:active { transform: scale(0.98); }
        .media-c.ok { border-style: solid; border-color: var(--primary); }
        .media-prev { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 1; background: #000; }
        .btn-del { 
            position: absolute; top: 6px; right: 6px; z-index: 10; background: rgba(0,0,0,0.6); 
            width: 26px; height: 26px; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white;
        }

        /* LIB BTNS & SUBMIT */
        .lib-btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .lib-btn { 
            background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; 
            display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-sub); font-size: 12px; font-weight: 700;
            box-shadow: var(--shadow-sm);
        }
        .lib-btn:active { transform: translateY(2px); }
        .btn-sub { 
            width: 100%; padding: 16px; background: var(--primary-grad); border: none; border-radius: var(--radius); 
            color: white; font-weight: 800; font-size: 16px; opacity: 0.5; pointer-events: none; transition: 0.3s;
            box-shadow: var(--shadow);
        }
        .btn-sub.ready { opacity: 1; pointer-events: auto; box-shadow: 0 10px 20px -5px var(--primary-light); transform: translateY(-2px); }
        .btn-sub.ready:active { transform: translateY(0); }

        /* QUEUE ITEM - REDESIGNED (3D & SHADOW) */
        .q-item { 
            background: var(--card); padding: 16px; border-radius: 20px; 
            margin-bottom: 14px; border: 1px solid var(--border); 
            box-shadow: var(--shadow); /* Bóng đổ 3D */
            position: relative; overflow: hidden;
        }
        .q-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .q-logo-wrap { 
            width: 32px; height: 32px; background: var(--bg); border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; margin-right: 10px;
            box-shadow: var(--shadow-inner);
        }
        .q-logo-img { width: 20px; height: 20px; object-fit: contain; }
        .q-code { font-weight: 800; font-size: 15px; color: var(--text); flex: 1; }
        .q-badge { 
            font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        /* Loading Bar Styles & Animation */
        .q-progress-bg { 
            width: 100%; height: 8px; background: var(--bg); border-radius: 10px; overflow: hidden; margin-bottom: 8px; 
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .q-progress-fill { 
            height: 100%; width: 0%; border-radius: 10px; background: var(--primary-grad);
            transition: width 0.3s ease-out; position: relative;
        }
        /* Hiệu ứng chạy (Stripes Animation) */
        .q-progress-fill::after {
            content: ""; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(
                45deg, 
                rgba(255, 255, 255, 0.15) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.15) 50%, 
                rgba(255, 255, 255, 0.15) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 20px 20px;
            animation: moveStripes 1s linear infinite;
        }

        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        /* DASHBOARD */
        .dash-c { display: grid; grid-template-columns: 1fr 1.2fr; gap: 12px; margin-bottom: 20px; }
        .dash-box { 
            background: var(--card); padding: 14px; border-radius: var(--radius); border: 1px solid var(--border); 
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column; justify-content: center; 
        }
        .pie-wrap { width: 60px; height: 60px; border-radius: 50%; position: relative; margin-right: 10px; flex-shrink: 0; box-shadow: var(--shadow);}
        .pie { width: 100%; height: 100%; border-radius: 50%; background: var(--border); transition: background 0.5s; }
        .pie-center { position: absolute; inset: 15%; background: var(--card); border-radius: 50%; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px; font-weight: 700; color: var(--text-sub); }
        .leg-item { display: flex; align-items: center; gap: 4px; }
        .leg-dot { width: 6px; height: 6px; border-radius: 50%; }

        /* SEARCH & FILTER */
        .search-row { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
        .search-box { 
            flex: 1; display: grid; grid-template-columns: 1fr 110px; gap: 8px; background: var(--card); 
            padding: 6px; border-radius: 14px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);
        }
        .search-box input { border: none; background: transparent; padding: 0 8px; font-size: 13px; color: var(--text); }
        .btn-refresh { 
            width: 40px; height: 40px; border-radius: 14px; background: var(--card); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; color: var(--text-sub); flex-shrink: 0; box-shadow: var(--shadow-sm);
        }
        .btn-refresh:active { transform: scale(0.95); }

        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 16px; scrollbar-width: none; }
        .filter-pill { 
            white-space: nowrap; padding: 6px 14px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 30px; font-size: 12px; font-weight: 600; color: var(--text-sub); transition: 0.2s; box-shadow: var(--shadow-sm);
        }
        .filter-pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px var(--primary-light); }
        .filter-pill img { height: 14px; vertical-align: middle; margin-right: 4px; }

        /* ADMIN LIST */
        .adm-card { 
            background: var(--card); padding: 12px; border-radius: 16px; border: 1px solid var(--border); 
            margin-bottom: 10px; display: flex; gap: 12px; align-items: center; box-shadow: var(--shadow);
        }
        .adm-thumb { width: 70px; height: 70px; background: var(--bg); border-radius: 10px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .logo-mini { width: 16px; height: 16px; object-fit: contain; vertical-align: middle; margin-right: 4px; }
        .adm-btn { padding: 6px 10px; background: var(--bg); border-radius: 6px; font-size: 10px; color: var(--text); border: 1px solid var(--border); font-weight: 700; flex: 1; margin-top: 6px; }

        /* PROGRESS BAR BOTTOM (UPDATED ANIMATION) */
        #total-prog { 
            position: fixed; bottom: var(--footer-h); left: 0; right: 0; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border); z-index: 999; 
            padding: 12px 16px; transform: translateY(110%); transition: 0.4s;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] #total-prog { background: rgba(30, 41, 59, 0.95); }
        #total-prog.show { transform: translateY(0); padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .prog-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .prog-detail { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700; color: var(--text); }
        .prog-logo { width: 20px; height: 20px; object-fit: contain; }
        .prog-badge { font-size: 10px; background: var(--border); padding: 2px 6px; border-radius: 4px; color: var(--text-sub); }
        
        /* Reuse animated bar style */
        .tp-bar-bg { width: 100%; height: 8px; background: var(--bg); border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .tp-bar-fill { 
            height: 100%; width: 0%; border-radius: 10px; background: var(--primary-grad);
            transition: width 0.3s ease-out; position: relative;
        }
        .tp-bar-fill::after {
            content: ""; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px; animation: moveStripes 1s linear infinite;
        }

        /* FOOTER */
        #fixed-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--footer-h); background: var(--card); 
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; 
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-btn { background: none; border: none; color: var(--text-sub); font-size: 11px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; width: 60px; }
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn.active span { transform: translateY(-3px); text-shadow: 0 4px 12px var(--primary-light); }
        .badge { background: var(--danger); color: white; font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 10px; position: absolute; top: -2px; right: 10px; display: none; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.4); }

        /* SCANNER MODAL */
        #scan-mod { position: fixed; inset: 0; z-index: 6000; background: black; display: none; }
        #scan-mod.active { display: block; }
        #qr-reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay {
            position: absolute; inset: 0; pointer-events: none;
            background: rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .scan-box {
            width: 250px; height: 250px; border: 2px solid var(--primary); border-radius: 20px;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.6); position: relative;
        }
        .scan-box::after {
            content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 2px; background: var(--primary);
            box-shadow: 0 0 4px var(--primary); animation: scanLine 2s infinite linear;
        }
        @keyframes scanLine { 0% {top:10%} 50% {top:90%} 100% {top:10%} }
        .btn-close-scan {
            position: absolute; top: 40px; right: 20px; z-index: 6001; pointer-events: auto;
            width: 40px; height: 40px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;
        }

        /* LOGIN */
        #login-scr { background: var(--bg); transition: 0.3s; }
        .login-card { background: var(--card); padding: 30px 20px; border-radius: 24px; width: 85%; max-width: 350px; border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow-lg); }

        /* VIEW MODAL */
        #mod { position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; }
        .mod-tool-top { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 10; }
        .mod-icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body onload="startTime()">

    <div id="login-scr" style="position:fixed; inset:0; z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="login-card">
            <img src="https://i.ibb.co/NgF0D0WX/4.jpg" style="width:72px; border-radius:14px; margin-bottom:12px; box-shadow:var(--shadow)">
            <h1 style="font-size: 24px; margin: 0 0 4px 0; color: var(--text);">FERRONI</h1>
            <p style="color: var(--text-sub); font-size: 12px; margin-bottom: 20px;">Hệ thống quản lý đóng gói V2</p>
            <input type="text" id="usr" class="inp-main" placeholder="Tên đăng nhập" style="margin-bottom: 10px; text-align:center">
            <input type="password" id="pwd" class="inp-main" placeholder="Mật khẩu" style="margin-bottom: 20px; text-align:center">
            <button onclick="doLogin()" class="btn-sub ready">ĐĂNG NHẬP</button>
        </div>
    </div>

    <div id="scan-mod">
        <div class="btn-close-scan" onclick="stopScanner()"><span class="material-icons-round">close</span></div>
        <div id="qr-reader"></div>
        <div class="scan-overlay">
            <div class="scan-box"></div>
            <div style="color:white; margin-top:20px; font-weight:600; text-align:center; padding:0 20px">
                Di chuyển camera đến mã QR hoặc Mã vạch<br>
                <span style="font-size:12px; font-weight:400; opacity:0.8">(Hỗ trợ QR Code & Code 128 VTP)</span>
            </div>
        </div>
    </div>

    <div id="fixed-header">
        <div class="brand-c">
            <div class="app-logo"><img src="https://i.ibb.co/NgF0D0WX/4.jpg"></div>
            <div class="brand-txt">
                <div class="brand-name">FERRONI</div>
                <div id="real-time" class="brand-date">...</div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px">
            <div onclick="toggleTheme()" style="padding:6px; cursor:pointer">
                <span class="material-icons-round" style="color:var(--text-sub)">contrast</span>
            </div>
            <div id="user-display" style="font-size:13px; font-weight:700; color:var(--text)">...</div>
        </div>
    </div>

    <div id="main-scroll">
        <div id="p-rec" class="page active">
            <div class="main-tabs">
                <div class="tab-btn active" onclick="setMode('out')" id="t-out">ĐƠN ĐI (Out)</div>
                <div class="tab-btn" onclick="setMode('in')" id="t-in">ĐƠN HOÀN (In)</div>
            </div>

            <div class="channel-grid">
                <label><input type="radio" name="ch" value="Shopee" checked hidden class="ch-radio"><div class="ch-box"><img src="https://i.ibb.co/ymqBwR9K/shopee-logo-png-seeklogo-378738-removebg-preview.png"><span>Shopee</span></div></label>
                <label><input type="radio" name="ch" value="TikTok" hidden class="ch-radio"><div class="ch-box"><img src="https://i.ibb.co/0yZXscPz/Screenshot-2026-01-08-163441-removebg-preview.png"><span>TikTok</span></div></label>
                <label><input type="radio" name="ch" value="Lazada" hidden class="ch-radio"><div class="ch-box"><img src="https://i.ibb.co/0VqqmmCV/19a57791bf92848b511de18eaebca94a-removebg-preview.png"><span>Lazada</span></div></label>
                <label><input type="radio" name="ch" value="VTP" hidden class="ch-radio"><div class="ch-box"><img src="https://i.ibb.co/7dNs15VX/Screenshot-2026-01-08-164038.png"><span>Viettel</span></div></label>
            </div>

            <div class="inp-grp">
                <input type="text" id="o-code" class="inp-main" placeholder="Quét mã vận đơn...">
                <div class="btn-scan" onclick="startScanner()">
                    <span class="material-icons-round" style="color:white; font-size:22px;">qr_code_scanner</span>
                </div>
            </div>

            <div style="font-size:12px; font-weight:700; color:var(--text-sub); margin-bottom:8px; text-transform:uppercase">Media đóng gói</div>
            <div class="media-row">
                <div class="media-c" id="c-img" onclick="document.getElementById('i-img').click()">
                    <div class="btn-del" id="d-img" onclick="event.stopPropagation(); del('img')"><span class="material-icons-round" style="font-size:18px">close</span></div>
                    <span class="material-icons-round" style="font-size:32px; color:var(--primary); background:var(--primary-light); padding:10px; border-radius:50%">camera_alt</span>
                    <div style="font-size:11px; color:var(--text-sub); font-weight:700; margin-top:8px">CHỤP ẢNH</div>
                    <img id="v-img" class="media-prev">
                    <input type="file" id="i-img" class="hidden-inp" accept="image/*" capture="environment" onchange="onMedia(this,'img')">
                </div>
                <div class="media-c" id="c-vid" onclick="document.getElementById('i-vid').click()">
                    <div class="btn-del" id="d-vid" onclick="event.stopPropagation(); del('vid')"><span class="material-icons-round" style="font-size:18px">close</span></div>
                    <span class="material-icons-round" style="font-size:32px; color:var(--primary); background:var(--primary-light); padding:10px; border-radius:50%">videocam</span>
                    <div style="font-size:11px; color:var(--text-sub); font-weight:700; margin-top:8px">QUAY NHANH</div>
                    <video id="v-vid" class="media-prev" playsinline muted></video>
                    <input type="file" id="i-vid" class="hidden-inp" accept="video/*" capture="environment" onchange="onMedia(this,'vid')">
                </div>
            </div>

            <div class="lib-btn-row">
                <label class="lib-btn">
                    <span class="material-icons-round">photo_library</span>Thư viện
                    <input type="file" class="hidden-inp" accept="image/*" onchange="onMedia(this,'img')">
                </label>
                <label class="lib-btn" style="border-color:var(--primary); background:var(--primary-light); color:var(--primary-dark)">
                    <span class="material-icons-round">video_library</span>Video HD
                    <input type="file" class="hidden-inp" accept="video/*" onchange="onMedia(this,'vid')">
                </label>
            </div>

            <button id="btn-up" class="btn-sub" onclick="addQ()">LƯU ĐƠN HÀNG</button>
            <div style="height:80px"></div>
        </div>

        <div id="p-que" class="page">
            <h3 style="margin:0 0 15px 0; color:var(--text)">Danh sách chờ tải lên</h3>
            <div id="q-list"></div>
        </div>

        <div id="p-adm" class="page">
            <div id="adm-dash" class="dash-c" style="display:none">
                <div class="dash-box">
                    <div id="d-today" class="dash-num">0</div>
                    <div style="font-size:11px; color:var(--text-sub); font-weight:600">Đơn hôm nay</div>
                </div>
                <div class="dash-box" style="flex-direction:row; align-items:center; padding:10px">
                    <div class="pie-wrap">
                        <div id="d-pie" class="pie"></div>
                        <div class="pie-center"></div>
                    </div>
                    <div class="legend-grid" id="d-legend"></div>
                </div>
            </div>

            <div class="main-tabs">
                <div class="tab-btn active" onclick="setMode('out')" id="ta-out">ĐƠN ĐI</div>
                <div class="tab-btn" onclick="setMode('in')" id="ta-in">ĐƠN HOÀN</div>
            </div>

            <div class="search-row">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Tìm mã đơn..." onkeyup="renderAdm()">
                    <input type="date" id="date-filt" class="inp-date" onchange="renderAdm()">
                </div>
                <div class="btn-refresh" onclick="refreshAdm()"><span class="material-icons-round">refresh</span></div>
            </div>
            
            <div class="filter-scroll">
                <div class="filter-pill active" onclick="setFilt('All')" id="f-All">Tất cả</div>
                <div class="filter-pill" onclick="setFilt('Shopee')" id="f-Shopee"><img src="https://i.ibb.co/ymqBwR9K/shopee-logo-png-seeklogo-378738-removebg-preview.png"> Shopee</div>
                <div class="filter-pill" onclick="setFilt('TikTok')" id="f-TikTok"><img src="https://i.ibb.co/0yZXscPz/Screenshot-2026-01-08-163441-removebg-preview.png"> TikTok</div>
                <div class="filter-pill" onclick="setFilt('Lazada')" id="f-Lazada"><img src="https://i.ibb.co/0VqqmmCV/19a57791bf92848b511de18eaebca94a-removebg-preview.png"> Lazada</div>
                <div class="filter-pill" onclick="setFilt('VTP')" id="f-VTP"><img src="https://i.ibb.co/7dNs15VX/Screenshot-2026-01-08-164038.png"> Viettel</div>
            </div>

            <div id="adm-list"></div>
            <div style="height:60px"></div>
        </div>
    </div>

    <div id="total-prog">
        <div class="prog-info">
            <div class="prog-detail">
                <img id="tp-logo" class="prog-logo" src="">
                <span id="tp-txt">Đang tải...</span>
                <span id="tp-plus" class="prog-badge">+0</span>
            </div>
            <span id="tp-pct" style="font-size:12px; font-weight:800; color:var(--primary-dark)">0%</span>
        </div>
        <div class="tp-bar-bg"><div id="tp-fill" class="tp-bar-fill"></div></div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:10px; color:var(--text-sub); font-weight:600">
            <span id="tp-spd">0 MB/s</span>
            <span id="tp-eta">0s</span>
        </div>
    </div>

    <div id="fixed-footer">
        <button class="nav-btn active" onclick="go('rec')">
            <span class="material-icons-round">qr_code_2</span>Quay đơn
        </button>
        <button class="nav-btn" onclick="go('que')" style="position:relative">
            <span class="material-icons-round">cloud_queue</span>
            <div id="bdg" class="badge">0</div>Hàng chờ
        </button>
        <button class="nav-btn" onclick="go('adm')">
            <span class="material-icons-round">space_dashboard</span>Quản lý
        </button>
    </div>

    <div id="mod">
        <div class="mod-tool-top">
            <span style="color:white; font-weight:700" id="mod-title">Chi tiết</span>
            <div style="display:flex; gap:10px">
                <a id="dl-btn" href="#" target="_blank" class="mod-icon-btn"><span class="material-icons-round">download</span></a>
                <div class="mod-icon-btn" onclick="closeMod()"><span class="material-icons-round">close</span></div>
            </div>
        </div>
        <div class="mod-content">
            <iframe id="ifr" width="100%" height="100%" style="border:none; display:none; position:absolute; inset:0"></iframe>
            <img id="img-view">
        </div>
        <div class="mod-tool-bottom" id="mod-ctrls">
            <div class="mod-icon-btn" onclick="zoom(-0.5)"><span class="material-icons-round">remove</span></div>
            <div class="mod-icon-btn" onclick="resetZoom()"><span class="material-icons-round">restart_alt</span></div>
            <div class="mod-icon-btn" onclick="zoom(0.5)"><span class="material-icons-round">add</span></div>
        </div>
    </div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbz1rgAM0fV2OFkGqPRW1PYoJA_DvFA3vicGNLg-1U29XSRPrxV--3oHzWKU8_8WEMQV/exec";
    const logos = {'Shopee':'https://i.ibb.co/ymqBwR9K/shopee-logo-png-seeklogo-378738-removebg-preview.png','TikTok':'https://i.ibb.co/0yZXscPz/Screenshot-2026-01-08-163441-removebg-preview.png','Lazada':'https://i.ibb.co/0VqqmmCV/19a57791bf92848b511de18eaebca94a-removebg-preview.png','VTP':'https://i.ibb.co/7dNs15VX/Screenshot-2026-01-08-164038.png'};
    let user=null, mode='Đơn đi', filt='All', Q=[], up=false, db=[];
    let curScale = 1; html5QrCode = null;

    // Theme & Clock
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme(){
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    function startTime() {
        const today = new Date();
        const d = String(today.getDate()).padStart(2,'0');
        const m = String(today.getMonth()+1).padStart(2,'0');
        document.getElementById('real-time').innerHTML = `${d}/${m}/${today.getFullYear()}`;
        
        if(!document.getElementById('date-filt').value){
            document.getElementById('date-filt').value = today.toISOString().slice(0,10);
        }
        setTimeout(startTime, 60000); 
    }

    // Login
    function doLogin(){
        const u=document.getElementById('usr').value, p=document.getElementById('pwd').value;
        if(!u||!p) return;
        document.querySelector('#login-scr button').innerText="ĐANG TẢI...";
        fetch(API,{method:'POST',body:JSON.stringify({action:'login',user:u,pass:p})})
        .then(r=>r.json()).then(d=>{
            if(d.result==='success'){
                user=d; document.getElementById('login-scr').style.display='none';
                document.getElementById('user-display').innerText=d.name;
                if(d.role==='admin') refreshAdm();
            } else { alert(d.message); document.querySelector('#login-scr button').innerText="ĐĂNG NHẬP"; }
        });
    }

    function go(p){
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('p-'+p).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function setMode(m){
        mode = m==='out'?'Đơn đi':'Đơn hoàn';
        const id1 = m==='out'?'t-out':'t-in'; const id2 = m==='out'?'ta-out':'ta-in';
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(id1).classList.add('active'); document.getElementById(id2).classList.add('active');
        if(document.getElementById('p-adm').style.display==='block') renderAdm();
    }

    function setFilt(f){
        filt = f;
        document.querySelectorAll('.filter-pill').forEach(e=>e.classList.remove('active'));
        document.getElementById('f-'+f).classList.add('active');
        renderAdm();
    }

    // --- SCANNER LOGIC (POPUP + BARCODE SUPPORT) ---
    function startScanner(){
        document.getElementById('scan-mod').classList.add('active');
        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspect: 1.0 };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            alert("Lỗi camera: " + err);
            stopScanner();
        });
    }

    function stopScanner(){
        if(html5QrCode){
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('scan-mod').classList.remove('active');
            }).catch(err => console.log(err));
        } else {
            document.getElementById('scan-mod').classList.remove('active');
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        if(navigator.vibrate) navigator.vibrate(200);
        document.getElementById('o-code').value = decodedText;
        stopScanner();
        chk();
    }

    // Media Logic
    let fI=null, fV=null;
    function onMedia(e,k){
        if(e.files[0]){
            const f=e.files[0];
            if(k==='img'){
                addWatermark(f, (blob)=>{ fI=blob; show('img', URL.createObjectURL(blob)); chk(); });
            } else { fV=f; show('vid', URL.createObjectURL(f)); chk(); }
            e.value = '';
        }
    }

    function addWatermark(file, callback) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const code = document.getElementById('o-code').value || "NO CODE";
                const time = new Date().toLocaleString('vi-VN');
                const staff = user ? user.name : "NV";
                
                const fontSize = Math.max(20, canvas.width / 25);
                const padding = fontSize / 2;
                ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                ctx.fillRect(0, canvas.height - (fontSize * 3.5), canvas.width, fontSize * 3.5);

                ctx.font = `bold ${fontSize}px Arial`; ctx.fillStyle = "#84cc16"; 
                ctx.fillText(`MÃ: ${code}`, padding, canvas.height - (fontSize * 1.8));
                ctx.font = `${fontSize * 0.7}px Arial`; ctx.fillStyle = "#ffffff";
                ctx.fillText(`${time} | ${staff}`, padding, canvas.height - (fontSize * 0.8));

                canvas.toBlob((blob) => { callback(blob); }, 'image/jpeg', 0.8);
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function show(k,u){
        document.getElementById('v-'+k).src=u; document.getElementById('v-'+k).style.display='block';
        document.getElementById('c-'+k).classList.add('ok'); document.getElementById('d-'+k).style.display='flex';
    }
    function del(k){
        if(k==='img'){ fI=null; } else { fV=null; }
        document.getElementById('v-'+k).src=''; document.getElementById('v-'+k).style.display='none';
        document.getElementById('c-'+k).classList.remove('ok'); document.getElementById('d-'+k).style.display='none';
        chk();
    }
    function chk(){
        if(document.getElementById('o-code').value && fI && fV) document.getElementById('btn-up').classList.add('ready');
        else document.getElementById('btn-up').classList.remove('ready');
    }

    // Upload Queue Logic
    function addQ(){
        const c=document.getElementById('o-code').value, ch=document.querySelector('input[name="ch"]:checked').value;
        Q.push({id:Date.now(), c:c, ch:ch, tp:mode, sf:user.name, img:fI, vid:fV, st:'waiting', pg:0, spd:0, loaded:0, total:(fV.size/1024/1024).toFixed(1), eta: '...'});
        if(navigator.vibrate) navigator.vibrate(50); renQ(); rst(); if(!up) run();
    }
    function rst(){ document.getElementById('o-code').value=''; del('img'); del('vid'); }

    async function run(){
        if(Q.length===0){up=false;return;}
        const idx=Q.findIndex(x=>x.st==='waiting');
        if(idx===-1){up=false;return;}
        up=true; const j=Q[idx]; j.st='uploading'; renQ();

        try {
            const bI = await toB64(j.img);
            const rI = await api({action:'upload_chunk', data:bI, fileName:`IMG_${j.c}.jpg`, mimeType:j.img.type, isFirst:true, isLast:true});
            
            const SZ = 1.5 * 1024 * 1024; const tot = j.vid.size;
            let start = 0, fid = null, vUrl = "";
            
            while(start < tot){
                const tS = Date.now();
                const end = Math.min(start + SZ, tot);
                const chunk = j.vid.slice(start, end);
                const b64 = await toB64(chunk);
                
                const res = await api({
                    action:'upload_chunk', data:b64, fileName:`VID_${j.c}.mp4`, 
                    mimeType:j.vid.type, isFirst:(start===0), isLast:(end >= tot), fileId:fid
                });
                if(res.result === "error") throw new Error(res.message);
                fid = res.fileId; if(end >= tot) vUrl = res.fileUrl;

                const dur = (Date.now() - tS) / 1000;
                const spd = (end - start) / 1024 / 1024 / dur;
                j.spd = spd.toFixed(1);
                j.loaded = (end/1024/1024).toFixed(1);
                j.pg = Math.round((end/tot)*99);
                j.eta = Math.round(((tot-end)/1024/1024)/spd) + "s";
                renQ(); start = end;
            }
            await api({action:'save_meta', maDon:j.c, type:j.tp, channel:j.ch, staffName:j.sf, videoUrl:vUrl, thumbLink:rI.thumbLink}); 
            j.st='done'; j.pg=100; setTimeout(()=>{Q=Q.filter(x=>x.id!==j.id); renQ();}, 2000); refreshAdm();
        } catch(e){ j.st='error'; alert("Lỗi tải lên: " + e.message); }
        renQ(); setTimeout(run,500);
    }

    function renQ(){
        const el=document.getElementById('q-list'); const count = Q.length;
        document.getElementById('bdg').innerText=count; document.getElementById('bdg').style.display=count?'block':'none';
        const bar = document.getElementById('total-prog');
        
        if(count > 0) {
            bar.classList.add('show');
            const u = Q.find(x=>x.st==='uploading');
            const pending = count - 1;
            if(u) {
                document.getElementById('tp-txt').innerText = u.c;
                document.getElementById('tp-logo').src = logos[u.ch];
                document.getElementById('tp-plus').innerText = `+${pending}`;
                document.getElementById('tp-pct').innerText = `${u.pg}%`;
                document.getElementById('tp-fill').style.width = u.pg + '%';
                document.getElementById('tp-spd').innerText = `${u.spd} MB/s`;
                document.getElementById('tp-eta').innerText = `Còn ${u.eta}`;
            } else {
                document.getElementById('tp-txt').innerText = "Chờ mạng...";
                document.getElementById('tp-plus').innerText = `+${count}`;
            }
        } else { bar.classList.remove('show'); }

        el.innerHTML=Q.map(x=>`
            <div class="q-item">
                <div class="q-header">
                    <div style="display:flex; align-items:center;">
                        <div class="q-logo-wrap"><img src="${logos[x.ch]}" class="q-logo-img"></div>
                        <div class="q-code">${x.c}</div>
                    </div>
                    <div class="q-badge" style="color:${x.st==='done'?'#10b981': x.st==='error'?'#ef4444':'#facc15'}; background:${x.st==='done'?'rgba(16,185,129,0.1)': x.st==='error'?'rgba(239,68,68,0.1)':'rgba(250,204,21,0.1)'}">${x.st.toUpperCase()}</div>
                </div>
                
                <div class="q-progress-bg"><div class="q-progress-fill" style="width:${x.pg}%"></div></div>
                
                <div style="font-size:11px; color:var(--text-sub); display:flex; justify-content:space-between; font-weight:600">
                    <span>${x.loaded}/${x.total} MB</span>
                    <span>${x.spd} MB/s</span>
                </div>
            </div>`).join('');
    }

    // Dashboard & Admin
    function refreshAdm(){
        const btn = document.querySelector('.btn-refresh');
        btn.innerHTML = '<span class="material-icons-round" style="animation:spin 1s infinite linear">sync</span>';
        api({action:'get_report'}).then(d=>{ 
            db=d; renderDash(); renderAdm(); 
            btn.innerHTML='<span class="material-icons-round">refresh</span>'; 
        });
    }

    function renderDash(){
        document.getElementById('adm-dash').style.display='grid';
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        const todayStr = `${d}/${m}/${y}`;

        const todayData = db.filter(x => {
            if(!x.time) return false;
            const itemDate = String(x.time).split(' ')[0]; 
            return itemDate.includes(todayStr) || String(x.time).startsWith(`${y}-${m}-${d}`);
        });

        document.getElementById('d-today').innerText = todayData.length;

        const C = { Shopee:0, TikTok:0, Lazada:0, VTP:0 };
        todayData.forEach(x => { if(C[x.channel]!==undefined) C[x.channel]++ });
        const tot = todayData.length || 1;
        const pS=(C.Shopee/tot)*100, pT=(C.TikTok/tot)*100, pL=(C.Lazada/tot)*100;
        
        document.getElementById('d-pie').style.background = 
            `conic-gradient(var(--chart-shopee) 0% ${pS}%, var(--chart-tiktok) ${pS}% ${pS+pT}%, var(--chart-lazada) ${pS+pT}% ${pS+pT+pL}%, var(--chart-other) ${pS+pT+pL}% 100%)`;
            
        document.getElementById('d-legend').innerHTML = `
            <div class="leg-item"><div class="leg-dot" style="background:var(--chart-shopee)"></div>S (${C.Shopee})</div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--chart-tiktok)"></div>T (${C.TikTok})</div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--chart-lazada)"></div>L (${C.Lazada})</div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--chart-other)"></div>V (${C.VTP})</div>`;
    }

    function renderAdm(){
        const k = document.getElementById('search').value.toLowerCase();
        const rawD = document.getElementById('date-filt').value;
        if(!rawD) return;
        const [y, m, d] = rawD.split('-');
        const d_vn = `${d}/${m}/${y}`;
        const d_iso = `${y}-${m}-${d}`;

        const data = db.filter(x => {
            const t = String(x.time);
            const dateMatch = t.includes(d_vn) || t.startsWith(d_iso);
            return dateMatch && x.code.toLowerCase().includes(k) && x.type === mode && (filt === 'All' || x.channel === filt);
        });

        const el = document.getElementById('adm-list');
        if(!data.length){ el.innerHTML='<div style="text-align:center; padding:30px; font-size:13px; color:var(--text-sub)">Không có dữ liệu</div>'; return; }
        
        el.innerHTML = data.map(x => `
            <div class="adm-card">
                <img src="${getThumb(x.imageUrl)}" class="adm-thumb" onclick="viewImg('${x.imageUrl}')">
                <div class="adm-info">
                    <div class="adm-code"><img src="${logos[x.channel]}" class="logo-mini"> ${x.code}</div>
                    <div style="font-size:11px; color:var(--text-sub);">${x.staff} • ${String(x.time).split(' ')[1] || ''}</div>
                    <div style="display:flex; gap:6px">
                        <button class="adm-btn" onclick="play('${x.videoUrl}')">VIDEO</button>
                        <button class="adm-btn" onclick="viewImg('${x.imageUrl}')">ẢNH</button>
                    </div>
                </div>
            </div>`).join('');
    }

    function getThumb(u){ return u ? `https://drive.google.com/thumbnail?id=${u.match(/[-\w]{25,}/)?.[0]}&sz=w200` : ''; }
    function getDL(u){ return u ? `https://drive.google.com/uc?export=download&id=${u.match(/[-\w]{25,}/)?.[0]}` : '#'; }

    function play(u){
        const id = u.match(/[-\w]{25,}/);
        if(id){
            openMod('VIDEO ĐÓNG GÓI', getDL(u), true);
            document.getElementById('ifr').src = `https://drive.google.com/file/d/${id[0]}/preview`;
            document.getElementById('ifr').style.display = 'block';
            document.getElementById('img-view').style.display = 'none';
            document.getElementById('mod-ctrls').style.display='none'; 
        }
    }
    
    function viewImg(u){
        if(!u) return;
        openMod('ẢNH XÁC THỰC', getDL(u), false);
        document.getElementById('img-view').src = `https://drive.google.com/thumbnail?id=${u.match(/[-\w]{25,}/)?.[0]}&sz=w1000`; 
        document.getElementById('img-view').style.display = 'block';
        document.getElementById('ifr').style.display = 'none';
        document.getElementById('mod-ctrls').style.display='flex';
        resetZoom();
    }

    function openMod(title, dlUrl, isVideo){
        document.getElementById('mod').style.display='flex';
        setTimeout(()=>document.getElementById('mod').classList.add('active'), 10);
        document.getElementById('mod-title').innerText = title;
        document.getElementById('dl-btn').href = dlUrl;
    }

    function closeMod(){ 
        document.getElementById('mod').classList.remove('active');
        setTimeout(()=>{
            document.getElementById('mod').style.display='none'; 
            document.getElementById('ifr').src=''; 
            document.getElementById('img-view').src=''; 
        }, 300);
    }

    function zoom(d){
        curScale += d; 
        if(curScale < 0.5) curScale = 0.5;
        if(curScale > 4) curScale = 4;
        document.getElementById('img-view').style.transform = `scale(${curScale})`;
    }
    function resetZoom(){ curScale=1; document.getElementById('img-view').style.transform = `scale(1)`; }

    function toB64(f){return new Promise((r)=>{const reader=new FileReader(); reader.onload=()=>r(reader.result.split(',')[1]); reader.readAsDataURL(f);});}
    function api(d){return fetch(API,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json());}
</script>
<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</body>
</html>
